name: Update All Branches from Main

on:
  schedule:
    - cron: '0 */12 * * *'  # Runs every 12 hours
  workflow_dispatch:  # Allows manual trigger

jobs:
  update-branches:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push updates
      pull-requests: write  # Required to create and merge PRs

    steps:
      - name: Set Git Identity (Fix Empty Ident Error)
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions@github.com"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all branches

      - name: Ensure logs directory and log file exist
        run: |
          mkdir -p logs
          touch logs/branch_update_log.txt  # Creates the file if it doesn’t exist

      - name: Append new log entry to log file (Ensure Change is Detected)
        run: |
          TIMESTAMP=$(date)
          echo "--- [$TIMESTAMP] - Sync Fork with Upstream ---" >> logs/branch_update_log.txt
          echo "- ✅ Log updated at: $TIMESTAMP" >> logs/branch_update_log.txt
          echo "" >> logs/branch_update_log.txt

      - name: Ensure Git Tracks Log File (Fix .gitignore Issues)
        run: |
          git add -f logs/branch_update_log.txt
          git update-index --refresh  # Ensure Git recognizes changes

      - name: Check if There Are Changes (Fix Silent Push Errors)
        id: git_status
        run: |
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes detected."
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            echo "Changes detected."
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          fi

      - name: Create a new branch for PR
        if: env.HAS_CHANGES == 'true'
        run: |
          BRANCH_NAME="update-logs-$(date +'%Y%m%d-%H%M%S')"
          git checkout -b $BRANCH_NAME
          git commit -m "Update branch update logs"
          git push origin $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request
        if: env.HAS_CHANGES == 'true'
        run: |
          gh pr create --title "Automated Log Update" --body "This PR updates the branch update logs." --base main --head ${{ env.BRANCH_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Approve the PR
        if: env.HAS_CHANGES == 'true'
        run: |
          gh pr review --approve --repo $GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge the PR Automatically (Ensure Updates Are Applied)
        if: env.HAS_CHANGES == 'true'
        run: |
          gh pr merge --squash --admin --repo $GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge main into other branches (Fix Checkout Error)
        run: |
          for branch in $(git branch -r | grep -v main | awk -F'origin/' '{print $2}'); do
            git stash  # Stash local changes before switching branches
            git checkout $branch || continue  # Skip if checkout fails
            git merge origin/main --no-edit || echo "Skipping merge due to conflicts"
            git push origin $branch || echo "No changes to push for $branch"
            git stash pop || echo "No stashed changes to restore"
          done
